import requests

from SpiderBase import SpiderBase
from requests_toolbelt.multipart.encoder import MultipartEncoder
from lxml import etree
from playwright.sync_api import sync_playwright


class SpiderNMS(SpiderBase):

    def fetch_item(self):
        data = MultipartEncoder({
            'page': '3',
            'action': '3',
            'ufprt': 'B2EB93A1DDDBAEB99F707703C8B32DD1FD0CB99C1A641DA932C40A9831264E531E75534D6DD4298D68CE813F46B26F88DBA97A19AD528CC7AAD02B704803B586965F56FB3358AF99DB35AD77898E755DC5989165AEB1F661125B187D2C7211B520258BA2C1B1D4172E1DE86B1C622B8B2D422A929E93DA8E0CCE5AAD61EF80E4D98357C6F3FCA3750DCD5A99DDCEEB84E80020DF1B1C5803DBE9550A81E30617'
        })
        content = requests.get(url="https://www.nms.ac.uk/explore-our-collections/collection-search-results/",
                               headers=self.headers, data=data).text
        with open('x.html', 'w', encoding='utf-8') as fp:
            fp.write(content)
        tree = etree.HTML(content)
        rows = tree.xpath('//*[@id="SiteMain"]/div/div[2]/div/div[2]/div[*]')

        # max_page = tree.xpath('//*[@id="resultsAltPagination"]/span[2]/text()')[0]
        # max_page = int(max_page)

        for row in rows:
            title = row.xpath('.//a[@class="itemTitle"]/text()')[0]
            img_url = row.xpath('.//a[@class="itemThumb"]/img/@src')[0]
            if img_url == '/images/no_image.gif':
                img_url = 'https://www.nms.ac.uk' + img_url
            else:
                img_url = 'https://www.nms.ac.uk/explore-our-collections/collection-search-results' + img_url
            print(title, img_url)


if __name__ == '__main__':
    spider = SpiderNMS()
    spider.fetch_item()
